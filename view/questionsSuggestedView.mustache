<section class="py-5 min-vh-100" style="background: url('../../QuizGame/public/img/background.png'); background-size: cover; background-position: center;">
    <div class="container my-4">
        <div class="card shadow-lg rounded-4">
            <div class="card-header bg-dark text-white text-center rounded-top-4 p-3">
                <h3 class="mb-0 fs-4">Panel de Preguntas Sugeridas</h3>
            </div>
            <div class="card-body p-2 p-md-3">
                {{#pregunta}}
                    <ul class="list-group list-group-flush" id="preguntas-sugeridas-lista">
                        <li class="list-group-item p-3" data-id-pregunta="{{id_pregunta}}">
                            <div class="row gy-3 align-items-center">
                                <div class="col-12 col-md-9">
                                    <span class="badge rounded-pill fw-semibold mb-2 fs-6" style="background-color: {{color}}; color: #fff;">{{nombre_categoria}}</span>
                                    <p class="mb-3 fw-bold fs-5 text-dark">{{texto}}</p>
                                    <div class="row gy-2">
                                        {{#respuestas}}
                                        <div class="col-12 col-sm-6">
                                            <div class="p-2 rounded-3 text-break {{#es_correcta}}bg-success-subtle text-success border fw-bold{{/es_correcta}}{{^es_correcta}}bg-light{{/es_correcta}}">
                                                <span>{{texto}}</span>
                                                {{#es_correcta}}<i class="fa-solid fa-check ms-2"></i>{{/es_correcta}}
                                            </div>
                                        </div>
                                        {{/respuestas}}
                                    </div>
                                    <div class="text-muted border-top pt-2 mt-3 small">Sugerido por: {{nombre_usuario}} - {{fecha_sugerencia}}</div>
                                </div>
                                <div class="col-12 col-md-3">
                                    <form class="accion-pregunta-form" method="POST">
                                        <input type="hidden" name="id_pregunta" value="{{id_pregunta}}">
                                        <div class="d-flex flex-row flex-md-column justify-content-end gap-2">
                                            <button type="submit" name="accion" value="aprobar" class="btn btn-success flex-grow-1"><i class="fa-solid fa-check me-2"></i>Aprobar</button>
                                            <button type="submit" name="accion" value="rechazar" class="btn btn-danger flex-grow-1"><i class="fa-solid fa-xmark me-2"></i>Rechazar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </li>
                    </ul>
                {{/pregunta}}
                {{^pregunta}}
                    <div class="text-center p-5">
                        <p class="fs-4 text-muted">¡Buen trabajo! No hay sugerencias pendientes.</p>
                        <i class="fa-solid fa-mug-saucer fa-3x text-light-emphasis"></i>
                    </div>
                {{/pregunta}}
            </div>
        </div>
    </div>
</section>


<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div id="modalIconContainer">
                </div>
                <h4 id="modalMessage" class="fw-bold"></h4>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        const modalMessage = document.getElementById('modalMessage');
        const modalIconContainer = document.getElementById('modalIconContainer');

        document.querySelectorAll('.accion-pregunta-form').forEach(form => {
            form.addEventListener('submit', function (event) {
                event.preventDefault();

                const form = this;
                const idPregunta = form.querySelector('input[name="id_pregunta"]').value;
                const accion = event.submitter.value;


                const formData = new FormData();
                formData.append('id_pregunta', idPregunta);
                formData.append('accion', accion);


                const url = '/QuizGame/question/aprobarPregunta';

                fetch(url, {
                    method: 'POST',
                    body: formData,
                })
                        .then(response => {

                            const contentType = response.headers.get('content-type');
                            if (contentType && contentType.indexOf('application/json') !== -1) {
                                return response.json();
                            } else {
                                console.error('Respuesta no es JSON:', response);
                                throw new Error('El servidor respondió con un formato inesperado.');
                            }
                        })
                        .then(data => {

                            modalMessage.textContent = data.mensaje;
                            modalIconContainer.innerHTML = '';

                            if (data.esExito) {
                                modalIconContainer.innerHTML = '<i class="fa-solid fa-circle-check text-success mb-3" style="font-size: 5rem;"></i>';
                            } else {
                                modalIconContainer.innerHTML = '<i class="fa-solid fa-circle-xmark text-danger mb-3" style="font-size: 5rem;"></i>';
                            }

                            confirmationModal.show();

                            setTimeout(() => {
                                confirmationModal.hide();
                            }, 2000);

                            const listItem = form.closest('li[data-id-pregunta]');
                            if (listItem) {
                                listItem.remove();
                            }
                        })
                        .catch(error => {
                            // console.error('Error en la petición AJAX:', error);
                            modalMessage.textContent = 'Ocurrió un error inesperado. Intenta de nuevo.';
                            modalIconContainer.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-warning mb-3" style="font-size: 5rem;"></i>';
                            confirmationModal.show();
                            setTimeout(() => {
                                confirmationModal.hide();
                            }, 3000); // CAMBIAR PARA QUE ESTE MAS TIEMPO ACA URA
                        });
            });
        });
    });
</script>
